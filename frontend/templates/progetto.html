<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{{ progetto_nome }} - QTasks</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="project-details-container">
        <!-- Back to dashboard -->
        <nav class="back-nav">
            <a href="/">‚Üê Back to dashboard</a>
        </nav>

        <h1 class="project-title">{{ progetto_nome }}</h1>

        <div class="dashboard-project-split">
            <!-- Colonna sinistra: Creazione task -->
            <div class="project-tasks-create-panel">
                <h2 class="section-title">Create new task</h2>
                <form method="post" action="/crea_task" enctype="multipart/form-data" class="create-task-form">
                    <input type="hidden" name="progetto_id" value="{{ progetto_id }}">
                    
                    <label for="titolo">Task name</label>
                    <input type="text" name="titolo" placeholder="e.g. Implementazione grafici" required>
                    
                    <label for="descrizione">Description</label>
                    <textarea name="descrizione" placeholder="Add a description..."></textarea>
                    
                   <label for="allegato" class="custom-file-upload">Upload file</label>
                    <input id="allegato" type="file" name="allegato" accept=".pdf,.jpg,.png,.doc,.xlsx,.zip,.txt" style="display: none;">
                    <span id="file-name" class="file-name-display">No file selected</span>

                    
                    <label for="stato">Status</label>
                    <select name="stato">
                        <option value="da_fare">Da fare</option>
                        <option value="in_corso">In corso</option>
                        <option value="completato">Completato</option>
                    </select>
                    
                    <label for="assegnato_a">Assignee</label>
                    <select name="assegnato_a">
                        <option value="">Nessuno</option>
                        {% for membro in membri_progetto %}
                            <option value="{{ membro.id }}">{{ membro.nome }}</option>
                        {% endfor %}
                    </select>
                    
                    <label for="scadenza">Due date</label>
                    <input type="date" name="scadenza">

                    <label for="parent_id">Sub-task of</label>
                    <select name="parent_id">
                        <option value="">Nessuno</option>
                        {% for task in tasks %}
                            <option value="{{ task.id }}">{{ task.titolo }}</option>
                        {% endfor %}
                    </select>
                    
                    <button type="submit" class="btn-accent">Crea Task</button>
                </form>
            </div>



            <!-- Colonna destra: Elenco task tabellare -->
            <div class="project-tasks-list-panel">
                <h2 class="section-title">Task del progetto</h2>
                <table class="table-tasks">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Assignee</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr>
                            <td>
                                {{ task.titolo }}
                                <span class="task-status">({{ task.stato }})</span>
                                {% if task.descrizione %}
                                    <br><span class="task-description">{{ task.descrizione }}</span>
                                {% endif %}
                                {% if allegati_per_task[task.id] and allegati_per_task[task.id]|length > 0 %}
                                    <div class="task-attachments" style="margin-top:0.5em;">
                                        <i class="fas fa-paperclip" style="font-size:0.95em;opacity:0.66;"></i>
                                        {% for allegato in allegati_per_task[task.id] %}
                                            <a href="{{ allegato.filepath }}" download style="margin-right:0.5em;">
                                                {{ allegato.filename }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.assegnato_a %}
                                    {% for membro in membri_progetto %}
                                        {% if membro.id == task.assegnato_a %}
                                            {{ membro.nome }}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Nessuno
                                {% endif %}
                            </td>
                            <td>
                                {% if task.scadenza %}
                                    {{ task.scadenza }}
                                {% endif %}
                            </td>
                            <td>
                                <a href="/modifica_task/{{ task.id }}?progetto_id={{ progetto_id }}" class="icon-edit" title="Modifica">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <form method="post" action="/elimina_task" style="display:inline;">
                                    <input type="hidden" name="task_id" value="{{ task.id }}">
                                    <input type="hidden" name="progetto_id" value="{{ progetto_id }}">
                                    <button type="submit" class="icon-delete" title="Elimina" onclick="return confirm('Sei sicuro di voler eliminare questo task e tutti i suoi subtasks?');">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>

                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4">Nessun task trovato</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>

<script>
document.getElementById('allegato').addEventListener('change', function () {
    const fileName = this.files[0] ? this.files[0].name : 'No file selected';
    document.getElementById('file-name').textContent = fileName;
});
</script>

</html>
