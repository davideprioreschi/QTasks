<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{{ progetto_nome }} - QTasks</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Progetto: {{ progetto_nome }}</h1>
    <a href="/">‚Üê Torna alla dashboard</a>
    
    <h2>Crea nuovo task</h2>
    <form method="post" action="/crea_task">
        <input type="hidden" name="progetto_id" value="{{ progetto_id }}">
        <input type="text" name="titolo" placeholder="Titolo task" required><br>
        <textarea name="descrizione" placeholder="Descrizione"></textarea><br>
        <select name="stato">
            <option value="da_fare">Da fare</option>
            <option value="in_corso">In corso</option>
            <option value="completato">Completato</option>
        </select><br>
        <label for="assegnato_a">Assegnato a:</label>
        <select name="assegnato_a">
            <option value="">Nessuno</option>
            {% for membro in membri_progetto %}
                <option value="{{ membro.id }}">{{ membro.nome }}</option>
            {% endfor %}
        </select><br>
        <label for="scadenza">Scadenza:</label>
        <input type="date" name="scadenza"><br>
        <label for="parent_id">Sotto-task di:</label>
        <select name="parent_id">
            <option value="">Nessuno (task principale)</option>
            {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.titolo }}</option>
            {% endfor %}
        </select><br>
        <button type="submit">Crea Task</button>
    </form>

    {% macro render_tasks(tasks, all_tasks, progetto_id, membri_progetto) -%}
    <ul>
        {% for task in tasks %}
        <li>
            <b>{{ task.titolo }}</b> ({{ task.stato }}) - {{ task.descrizione }}
            {% if task.assegnato_a %}
                - Assegnato a: 
                {% for membro in membri_progetto %}
                    {% if membro.id == task.assegnato_a %}
                        {{ membro.nome }}
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% if task.scadenza %}
                - Scadenza: {{ task.scadenza }}
            {% endif %}
            <form method="post" action="/elimina_task" style="display:inline;">
                <input type="hidden" name="task_id" value="{{ task.id }}">
                <input type="hidden" name="progetto_id" value="{{ progetto_id }}">
                <button type="submit" onclick="return confirm('Sei sicuro di voler eliminare questo task e tutti i suoi subtasks?');">Elimina</button>
            </form>
            <a href="/modifica_task/{{ task.id }}?progetto_id={{ progetto_id }}">Modifica</a>
            {% set child_tasks = [] %}
            {% for t in all_tasks %}
                {% if t.parent_id == task.id %}
                    {% set _ = child_tasks.append(t) %}
                {% endif %}
            {% endfor %}
            {% if child_tasks %}
                {{ render_tasks(child_tasks, all_tasks, progetto_id, membri_progetto) }}
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {%- endmacro %}

    <h2>Task del progetto</h2>
    {% set root_tasks = [] %}
    {% for t in tasks %}
        {% if not t.parent_id %}
            {% set _ = root_tasks.append(t) %}
        {% endif %}
    {% endfor %}
    {% if root_tasks %}
        {{ render_tasks(root_tasks, tasks, progetto_id, membri_progetto) }}
    {% else %}
        <ul><li>Nessun task trovato</li></ul>
    {% endif %}
</body>
</html>
